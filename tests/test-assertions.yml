---
- hosts: localhost
  remote_user: root

  vars:
    systemd_automount:
      - name: autostuff
        src: "someserver:/stuff"
        path: "/stuff"
        fstype: nfs
        opts:
          - _netdev
          - noauto
          - x-systemd.automount
          - x-systemd.idle-timeout=1min
      - name: autootherstuff
        src: "someotherserver:/otherstuff"
        path: "/otherstuff"
        fstype: smb
        opts:
          - _netdev
          - x-systemd.automount
          - noauto
          - x-systemd.idle-timeout=1min

    systemd_automount_enabled:
      - "autostuff"

  roles:
    - role_under_test

  tasks:
    - stat:
        path: "/etc/fstab"
      register: fstab

    - name: "TEST | Test Someserver"
      shell: "grep 'someserver' /etc/fstab"
      register: someserver

    - name: "TEST | Test Someotherserver"
      shell: "grep 'someotherserver' /etc/fstab"
      register: someotherserver

    - assert:
        that:
          - "fstab.stat.exists == true"
          - "someserver.rc == 0"
          - "someotherserver.rc != 0"
