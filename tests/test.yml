---
- hosts: localhost
  remote_user: root

  vars:
    autofs_indirect_maps:
      - name: auto.stuff
        path: "/stuff"
        enabled: "true"
        autofsoptions: "--timeout 1800"
        mode: "0755"

    enabled_autofs_indirect_maps:
      - "auto.stuff"

  pre_tasks:
    - name: TEST | Testing
      package:
        name: "{{item}}"
        state: installed
      with_items:
        - "nfs-utils"
    
    - name: TEST | Testing 1
      service:
        name: "{{item}}"
        state: started
        enabled: yes
      with_items:
        - "rpcbind"

  roles:
    - role_under_test

  tasks:
    - name: TEST | Check that /etc/auto.stuff exists
      stat:
        path: /etc/auto.stuff
      register: autostuff

    - name: TEST | Check that contents of auto.stuff are reasonable
      shell: grep "/stuff" /etc/auto.stuff
      register: autogrep
      when: autostuff.stat.exists

    - assert:
        that:
          - "autostuff.stat.exists is true"
          - "autogrep.rc == 0" 


